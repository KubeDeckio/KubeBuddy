checks:
  - ID: PVC001
    Name: Unused Persistent Volume Claims
    Section: Storage
    Category: Volumes
    ResourceKind: PersistentVolumeClaim
    Severity: Medium
    Weight: 2
    Description: Detects PVCs not attached to any pod.
    FailMessage: PVC is not used by any running pod.
    URL: https://kubernetes.io/docs/concepts/storage/persistent-volumes/
    Recommendation:
      text: Review and delete unused PVCs to reclaim storage.
      html: |
        <div class="recommendation-content">
          <h4>ðŸ’¾ Clean Up Unused PVCs</h4>
          <ul>
            <li><strong>Audit:</strong> Confirm PVC is not needed using <code>kubectl describe pvc -n &lt;namespace&gt;</code>.</li>
            <li><strong>Delete:</strong> Remove PVCs no longer required with <code>kubectl delete pvc &lt;name&gt;</code>.</li>
            <li><strong>Prevent:</strong> Automate cleanup for stale environments or ephemeral workloads.</li>
          </ul>
        </div>
      SpeechBubble:
        - "PVCs reserve storage in your cluster."
        - ""
        - "These are NOT in use by any pod."
        - "Check before deleting."
    Script: |
      param(
        [object]$KubeData,
        [switch]$ExcludeNamespaces
      )

      $pvcs = if ($null -ne $KubeData) {
        $KubeData.PersistentVolumeClaims.items
      } else {
        (kubectl get pvc --all-namespaces -o json | ConvertFrom-Json).items
      }

      if ($ExcludeNamespaces) {
        $pvcs = Exclude-Namespaces -items $pvcs
      }

      if (-not $pvcs -or $pvcs.Count -eq 0) {
        return @()
      }

      $pods = if ($null -ne $KubeData) {
        $KubeData.Pods.items
      } else {
        (kubectl get pods --all-namespaces -o json | ConvertFrom-Json).items
      }

      $attachedPVCs = $pods |
        ForEach-Object { $_.spec.volumes | Where-Object { $_.persistentVolumeClaim } } |
        Select-Object -ExpandProperty persistentVolumeClaim

      $unusedPVCs = $pvcs | Where-Object { $_.metadata.name -notin $attachedPVCs.name }

      $unusedPVCs | ForEach-Object {
        [PSCustomObject]@{
          Namespace = $_.metadata.namespace
          Resource  = "pvc/$($_.metadata.name)"
          Value     = $_.spec.resources.requests.storage
          Message   = "PVC is not used by any running pod"
        }
      }
